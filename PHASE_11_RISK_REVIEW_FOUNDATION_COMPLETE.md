# Phase 11: Risk Review System - Foundation Complete

## å®Ÿè£…å®Œäº†æ—¥
2025-12-08

## æ¦‚è¦
ãƒªã‚¹ã‚¯ç¢ºèªæ©Ÿèƒ½ï¼ˆRisk Review Systemï¼‰ã®åŸºç›¤å®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹ã®çŠ¶æ…‹ç®¡ç†ã€å‹•çš„ã‚¹ã‚³ã‚¢è¨ˆç®—ã€ç¿»è¨³ã‚­ãƒ¼ãŒå®Ÿè£…ã•ã‚Œã€UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å®Ÿè£…æº–å‚™ãŒæ•´ã„ã¾ã—ãŸã€‚

## å®Œäº†ã—ãŸã‚¿ã‚¹ã‚¯

### âœ… Task 34.1: RiskReviewState Data Models
**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/models.py`

å®Ÿè£…å†…å®¹:
- `RiskReviewState` dataclass
  - `risk_id`: ãƒ¦ãƒ‹ãƒ¼ã‚¯IDï¼ˆ"{sheet}_{cell}_{risk_type}"å½¢å¼ï¼‰
  - `is_reviewed`: ç¢ºèªæ¸ˆã¿ãƒ•ãƒ©ã‚°
  - `reviewed_at`: ç¢ºèªæ—¥æ™‚ï¼ˆOptionalï¼‰

- `ReviewProgress` dataclass
  - `total_risks`: ç·ãƒªã‚¹ã‚¯æ•°
  - `reviewed_count`: ç¢ºèªæ¸ˆã¿æ•°
  - `unreviewed_count`: æœªç¢ºèªæ•°
  - `percentage`: ç¢ºèªç‡ï¼ˆ0-100%ï¼‰
  - `initial_score`: åˆæœŸã‚¹ã‚³ã‚¢ï¼ˆå…¨ãƒªã‚¹ã‚¯ï¼‰
  - `current_score`: ç¾åœ¨ã‚¹ã‚³ã‚¢ï¼ˆæœªç¢ºèªãƒªã‚¹ã‚¯ã®ã¿ï¼‰
  - `improvement_delta`: æ”¹å–„åº¦ï¼ˆcurrent - initialï¼‰
  - `display_text` property: "ç¢ºèªæ¸ˆã¿: X/Y (Z%)"
  - `is_complete()`: å…¨ç¢ºèªãƒã‚§ãƒƒã‚¯
  - `is_halfway()`: 50%ä»¥ä¸Šãƒã‚§ãƒƒã‚¯
  - `get_encouragement_message()`: åŠ±ã¾ã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

### âœ… Task 34.2: RiskReviewStateManager
**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/risk_review.py`

å®Ÿè£…å†…å®¹:
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹ã®çŠ¶æ…‹ç®¡ç†
- `st.session_state.risk_review_states` ã«ä¿å­˜
- ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰:
  - `get_risk_id(risk)`: ãƒ¦ãƒ‹ãƒ¼ã‚¯IDç”Ÿæˆ
  - `is_reviewed(risk)`: ç¢ºèªçŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
  - `set_reviewed(risk, reviewed)`: çŠ¶æ…‹æ›´æ–°
  - `get_reviewed_count(risks)`: ç¢ºèªæ¸ˆã¿æ•°ã‚«ã‚¦ãƒ³ãƒˆ
  - `get_unreviewed_risks(risks)`: æœªç¢ºèªãƒªã‚¹ã‚¯å–å¾—
  - `get_reviewed_risks(risks)`: ç¢ºèªæ¸ˆã¿ãƒªã‚¹ã‚¯å–å¾—
  - `clear_all()`: å…¨çŠ¶æ…‹ã‚¯ãƒªã‚¢
  - `get_all_states()`: å…¨çŠ¶æ…‹å–å¾—

### âœ… Task 34.3: DynamicScoreCalculator
**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/risk_review.py`

å®Ÿè£…å†…å®¹:
- å‹•çš„ã‚¹ã‚³ã‚¢è¨ˆç®—ã‚¨ãƒ³ã‚¸ãƒ³
- ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰:
  - `calculate_initial_score(risks)`: åˆæœŸã‚¹ã‚³ã‚¢è¨ˆç®—
    - Formula: 100 - (CriticalÃ—10) - (HighÃ—5) - (MediumÃ—2)
  - `calculate_current_score(risks, state_manager)`: ç¾åœ¨ã‚¹ã‚³ã‚¢è¨ˆç®—
    - æœªç¢ºèªãƒªã‚¹ã‚¯ã®ã¿ã§ã‚¹ã‚³ã‚¢è¨ˆç®—
  - `calculate_progress(risks, state_manager)`: é€²æ—è¨ˆç®—
    - ReviewProgressã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™
    - å…¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å«ã‚€

### âœ… Task 40.3: Translation Keys
**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/i18n.py`

è¿½åŠ ã—ãŸç¿»è¨³ã‚­ãƒ¼ï¼ˆæ—¥æœ¬èªãƒ»è‹±èªï¼‰:
- `review_checkbox`: "ç¢ºèª" / "Review"
- `review_checkbox_help`: "ã“ã®ãƒªã‚¹ã‚¯ã‚’ç¢ºèªæ¸ˆã¿ã«ã™ã‚‹" / "Mark this risk as reviewed"
- `initial_score`: "åˆæœŸã‚¹ã‚³ã‚¢" / "Initial Score"
- `current_score`: "ç¾åœ¨ã‚¹ã‚³ã‚¢" / "Current Score"
- `improvement`: "æ”¹å–„" / "Improvement"
- `reviewed_count`: "ç¢ºèªæ¸ˆã¿" / "Reviewed"
- `unreviewed_count`: "æœªç¢ºèª" / "Unreviewed"
- `filter_all`: "ã™ã¹ã¦" / "All"
- `filter_unreviewed`: "æœªç¢ºèªã®ã¿" / "Unreviewed Only"
- `filter_reviewed`: "ç¢ºèªæ¸ˆã¿ã®ã¿" / "Reviewed Only"
- `export_with_review_state`: "CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆç¢ºèªçŠ¶æ…‹ã‚’å«ã‚€ï¼‰" / "Download CSV (with review state)"
- `all_reviewed_message`: "ğŸ‰ ã™ã¹ã¦ã®ãƒªã‚¹ã‚¯ã‚’ç¢ºèªã—ã¾ã—ãŸï¼" / "ğŸ‰ All risks reviewed!"
- `keep_going_message`: "ğŸ’ª ã‚ã¨{count}å€‹ã§ã™ï¼" / "ğŸ’ª {count} more to go!"
- `review_progress`: "ãƒ¬ãƒ“ãƒ¥ãƒ¼é€²æ—" / "Review Progress"
- `display_filter`: "è¡¨ç¤ºãƒ•ã‚£ãƒ«ã‚¿ãƒ¼" / "Display Filter"

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Risk Review System                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Checkbox    â”‚  â”‚   Score      â”‚  â”‚   Filter     â”‚     â”‚
â”‚  â”‚  State Mgr   â”‚  â”‚  Calculator  â”‚  â”‚   Engine     â”‚     â”‚
â”‚  â”‚  (Session)   â”‚  â”‚  (Dynamic)   â”‚  â”‚              â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    UI Components                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Checkbox    â”‚  â”‚  Progress    â”‚  â”‚  CSV Export  â”‚     â”‚
â”‚  â”‚  Column      â”‚  â”‚  Display     â”‚  â”‚  with State  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä¸»è¦æ©Ÿèƒ½

### 1. ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹ç®¡ç†
- `st.session_state` ã«ä¿å­˜
- ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ã«è‡ªå‹•ã‚¯ãƒªã‚¢
- æ°¸ç¶šåŒ–ãªã—ï¼ˆæ„å›³çš„ãªè¨­è¨ˆï¼‰

### 2. å‹•çš„ã‚¹ã‚³ã‚¢è¨ˆç®—
- **åˆæœŸã‚¹ã‚³ã‚¢**: å…¨ãƒªã‚¹ã‚¯ãƒ™ãƒ¼ã‚¹
- **ç¾åœ¨ã‚¹ã‚³ã‚¢**: æœªç¢ºèªãƒªã‚¹ã‚¯ã®ã¿
- **æ”¹å–„åº¦**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°

### 3. é€²æ—ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°
- ç¢ºèªç‡ï¼ˆãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ï¼‰
- ç¢ºèªæ¸ˆã¿/æœªç¢ºèªã‚«ã‚¦ãƒ³ãƒˆ
- åŠ±ã¾ã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

## ä½¿ç”¨ä¾‹

```python
from src.risk_review import RiskReviewStateManager, DynamicScoreCalculator
from src.models import RiskAlert

# åˆæœŸåŒ–
state_manager = RiskReviewStateManager()
calculator = DynamicScoreCalculator()

# ãƒªã‚¹ã‚¯ãƒªã‚¹ãƒˆï¼ˆä¾‹ï¼‰
risks = [...]  # List[RiskAlert]

# é€²æ—è¨ˆç®—
progress = calculator.calculate_progress(risks, state_manager)

print(progress.display_text)  # "ç¢ºèªæ¸ˆã¿: 45/131 (34%)"
print(f"åˆæœŸã‚¹ã‚³ã‚¢: {progress.initial_score}")  # 65
print(f"ç¾åœ¨ã‚¹ã‚³ã‚¢: {progress.current_score}")  # 78
print(f"æ”¹å–„: +{progress.improvement_delta}")  # +13

# ãƒªã‚¹ã‚¯ã‚’ç¢ºèªæ¸ˆã¿ã«ãƒãƒ¼ã‚¯
state_manager.set_reviewed(risks[0], True)

# çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
if state_manager.is_reviewed(risks[0]):
    print("ç¢ºèªæ¸ˆã¿ï¼")

# ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
unreviewed = state_manager.get_unreviewed_risks(risks)
reviewed = state_manager.get_reviewed_risks(risks)
```

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆæ®‹ã‚Šã®ã‚¿ã‚¹ã‚¯ï¼‰

### Task 35: Checkbox UI Implementation
- ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹åˆ—ã®è¿½åŠ 
- è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆï¼‰
- çŠ¶æ…‹åŒæœŸ

### Task 36: Progress Display
- ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡¨ç¤ºï¼ˆ4ã¤ã®st.metricï¼‰
- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼
- åŠ±ã¾ã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

### Task 37: Filter System
- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ï¼‰
- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°

### Task 38: CSV Export Enhancement
- ç¢ºèªçŠ¶æ…‹åˆ—ã®è¿½åŠ 
- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—åˆ—ã®è¿½åŠ 
- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³æ›´æ–°

### Task 39: Integration & Testing
- Master-Detail UIã¨ã®çµ±åˆ
- Triage Systemã¨ã®çµ±åˆ
- ãƒ˜ãƒ«ã‚¹ã‚¹ã‚³ã‚¢è¡¨ç¤ºã®æ›´æ–°
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
- E2Eãƒ†ã‚¹ãƒˆ

### Task 40: Documentation & Polish
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°
- ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¿½åŠ 
- æœ€çµ‚ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ

## ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### Unit Testsï¼ˆä»Šå¾Œå®Ÿè£…ï¼‰
- `test_risk_review_state_manager.py`
  - çŠ¶æ…‹ç®¡ç†ã®å„ãƒ¡ã‚½ãƒƒãƒ‰
  - ãƒ¦ãƒ‹ãƒ¼ã‚¯IDç”Ÿæˆ
  - çŠ¶æ…‹ã®å–å¾—/è¨­å®š

- `test_dynamic_score_calculator.py`
  - ã‚¹ã‚³ã‚¢è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
  - é€²æ—è¨ˆç®—
  - ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹

### Property Testsï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- Property 13: Review state consistency
- Property 14: Progress calculation accuracy
- Property 15: Filter correctness
- Property 16: CSV export completeness
- Property 17: Session isolation
- Property 18: Score improvement monotonicity

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›®æ¨™

- çŠ¶æ…‹æ›´æ–°: <50ms
- ã‚¹ã‚³ã‚¢è¨ˆç®—: <100ms
- ãƒ†ãƒ¼ãƒ–ãƒ«å†æç”»: <500msï¼ˆ100ãƒªã‚¹ã‚¯ï¼‰

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

1. **çŠ¶æ…‹åˆ†é›¢**: ã‚»ãƒƒã‚·ãƒ§ãƒ³é–“ã§ãƒ‡ãƒ¼ã‚¿æ¼æ´©ãªã—
2. **CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ**: æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ãªã—ï¼ˆãƒªã‚¹ã‚¯ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼‰
3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ¶é™**: 1000ãƒªã‚¹ã‚¯/ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸Šé™

## å®Œäº†åŸºæº–

âœ… ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«å®šç¾©å®Œäº†
âœ… çŠ¶æ…‹ç®¡ç†å®Ÿè£…å®Œäº†
âœ… ã‚¹ã‚³ã‚¢è¨ˆç®—å®Ÿè£…å®Œäº†
âœ… ç¿»è¨³ã‚­ãƒ¼è¿½åŠ å®Œäº†
â³ UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®Ÿè£…ï¼ˆæ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼‰
â³ çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆæ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼‰
â³ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆï¼ˆæ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼‰

## å‚™è€ƒ

- ã™ã¹ã¦ã®ã‚³ãƒ¼ãƒ‰ã¯PEP 8æº–æ‹ 
- å‹ãƒ’ãƒ³ãƒˆå®Œå‚™
- Docstringå®Œå‚™
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã«ã‚ˆã‚Šã€æ°¸ç¶šåŒ–ã®è¤‡é›‘ã•ã‚’å›é¿
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã«ã‚ˆã‚‹UXå‘ä¸Š

---

**æ¬¡å›ã‚»ãƒƒã‚·ãƒ§ãƒ³**: UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆTask 35-38ï¼‰ã®å®Ÿè£…ã«é€²ã¿ã¾ã™ã€‚
