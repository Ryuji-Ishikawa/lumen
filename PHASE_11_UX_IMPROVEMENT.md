# Phase 11: Risk Review System - UX Improvement

## 変更日
2025-12-08

## 変更内容

### 問題点
- リスク確認モードをトグルで切り替える必要があり、詳細パネルが見られない
- ユーザーがリスクの詳細を確認しながらチェックボックスを操作できない
- UXが分断されている

### 解決策
トグルスイッチを削除し、デフォルトでリスク確認機能を統合：

1. **進捗表示**: タブの上部に常に表示
2. **フィルター**: 未確認/確認済み/すべて を切り替え
3. **テーブル**: 確認状態を絵文字（✅/⬜）で表示
4. **チェックボックス**: テーブルの下に配置
5. **詳細パネル**: 右コラムに常に表示
6. **CSVエクスポート**: 下部に配置

### 新しいレイアウト

```
┌─────────────────────────────────────────────────────────────┐
│  📊 レビュー進捗                                             │
│  初期: 65  現在: 78 (+13)                                    │
│  確認済み: 45/131 (34%)                                      │
│  ████████░░ 34%                                              │
└─────────────────────────────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│  フィルター: ○すべて ○未確認 ○確認済み                        │
└─────────────────────────────────────────────────────────────┘
                     ↓
┌──────────────────────────────┬──────────────────────────────┐
│  📋 リスク一覧 (左)           │  🔍 詳細パネル (右)           │
│                              │                              │
│  ┌────────────────────────┐ │  ┌────────────────────────┐ │
│  │ 確認 | 場所 | 項目 | ... │ │  │ 場所: BS!E92          │ │
│  │ ✅  | BS!E92 | Cash |   │ │  │ 項目名: Cash          │ │
│  │ ⬜  | PL!F24 | Rev  |   │ │  │ リスク: Critical      │ │
│  │ ⬜  | BS!G15 | AR   |   │ │  │                       │ │
│  └────────────────────────┘ │  │ ロジックX線:          │ │
│                              │  │ - 参照元              │ │
│  確認操作:                    │  │ - 分析対象            │ │
│  [☑] E92  [☐] F24  [☐] G15  │  │ - 影響先              │ │
│                              │  │                       │ │
│                              │  │ 修正案:               │ │
│                              │  │ (AI提案)              │ │
│                              │  └────────────────────────┘ │
└──────────────────────────────┴──────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────────┐
│  📥 CSVダウンロード（確認状態を含む）                         │
└─────────────────────────────────────────────────────────────┘
```

### 主要な変更

#### 1. `render_master_detail_ui()` の更新
**変更前:**
```python
# トグルスイッチで切り替え
review_mode = st.toggle("🎯 リスク確認モード", value=False)

if review_mode:
    render_risk_review_interface(risks, lang)
else:
    render_traditional_master_detail(risks, model, lang)
```

**変更後:**
```python
# デフォルトで統合
# 1. 進捗表示
render_progress_display(progress, lang)

# 2. フィルター
filter_mode = render_filter_controls(lang)

# 3. Master-Detail レイアウト
master_col, detail_col = st.columns([3, 2])

with master_col:
    # テーブル + チェックボックス
    selected_risk = render_master_risk_table_with_checkboxes(...)

with detail_col:
    # 詳細パネル
    render_detail_panel(selected_risk, model, lang)

# 4. CSVエクスポート
st.download_button(...)
```

#### 2. `render_master_risk_table_with_checkboxes()` の実装
- テーブルに確認状態を絵文字で表示（✅/⬜）
- テーブルの下にチェックボックスを配置
- 行選択で詳細パネルを更新
- チェックボックス操作で確認状態を更新

### ユーザー体験の改善

#### Before (変更前):
1. リスク一覧を見る
2. トグルをONにする
3. リスク確認モードに切り替わる
4. **詳細が見られない** ❌
5. トグルをOFFにして詳細を見る
6. また確認したい場合はトグルをON...

#### After (変更後):
1. リスク一覧を見る
2. 行をクリックして詳細を確認 ✅
3. チェックボックスで確認済みにマーク ✅
4. 進捗がリアルタイムで更新される ✅
5. **すべてが同時に見られる** ✅

### 利点

✅ **シームレスな体験**: モード切り替え不要  
✅ **詳細確認**: 右パネルで常に詳細が見られる  
✅ **効率的**: 確認と詳細確認を同時に実行  
✅ **直感的**: 絵文字で確認状態が一目瞭然  
✅ **柔軟**: フィルターで未確認のみに絞り込み可能

### 技術的な詳細

#### 確認状態の表示
- テーブル内: 絵文字（✅ = 確認済み、⬜ = 未確認）
- チェックボックス: テーブルの下に配置（セル番号でラベル）

#### 状態管理
- `RiskReviewStateManager`: セッションベースの状態管理
- チェックボックス変更時に `st.rerun()` で即座に更新
- 進捗とスコアがリアルタイムで反映

#### レイアウト
- 左コラム (60%): リスク一覧 + チェックボックス
- 右コラム (40%): 詳細パネル
- 上部: 進捗表示 + フィルター
- 下部: CSVエクスポート

### 実装ファイル

**更新:**
- `src/master_detail_ui.py`:
  - `render_master_detail_ui()` - トグル削除、統合レイアウト
  - `render_master_risk_table_with_checkboxes()` - 新規実装

**変更なし:**
- `src/risk_review.py` - 既存の関数をそのまま使用
- `src/models.py` - データモデルは変更なし
- `app.py` - 呼び出し側は変更なし

### テスト

既存のテストは全て合格：
```bash
$ python -m pytest tests/test_risk_review_ui.py -v
14 tests passed ✅
```

### 今後の改善案

1. **インラインチェックボックス**: テーブル内にチェックボックスを直接配置（Streamlitの制約により現在は困難）
2. **キーボードショートカット**: スペースキーで確認/未確認を切り替え
3. **バッチ操作**: 複数リスクを一括で確認済みにする
4. **確認コメント**: 確認時にコメントを追加できる機能

---

**UX改善完了！** ユーザーはリスクの詳細を確認しながら、シームレスにチェックボックスで確認状態を管理できるようになりました。
